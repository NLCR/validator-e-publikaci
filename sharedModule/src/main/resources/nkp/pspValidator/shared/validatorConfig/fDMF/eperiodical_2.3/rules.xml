<fDMF xmlns="http://www.nkp.cz/validatorEpublikaci/1.0/fdmfConfig"
      validatorVersion="1.0"
      dmf="eperiodical_2.3"
>
    <description>
        Zde jsou definovány validační pravidla. K samotným validacím se používají validační funkce, jejichž parametry
        jsou definované proměnné, vzory a konstanty.
        Pravidla je možné dynamicky doplňovat/upravovat, ale je vždy nutné používat existující proměnné a vzory.
    </description>

    <rules-section name="Struktura souborů" description="Struktura PSP balicku na urovni soboru">

        <!--mozna tohle patri spise k INFO?-->
        <!--TODO: spis pouzit pattern a checkFilenameMatchesPattern, kdyz matches-->
        <rule name="PSP_DIR_MATCHES_PSP_ID">
            <description>Název kořenového adresáře musí být schodný s PSP-ID.</description>
            <validation functionName="checkFilenameMatchesPattern">
                <params>
                    <value name="level" type="LEVEL">ERROR</value>
                    <value name="file" type="FILE">
                        <value-ref name="PSP_DIR"/>
                    </value>
                    <pattern name="pattern">
                        <expression caseSensitive="true">${PSP_ID}</expression>
                    </pattern>
                </params>
            </validation>
        </rule>


        <!--právě jeden každý top-level soubor-->

        <rule name="SINGLE_INFO_FILE_FOUND">
            <description>Musí být nalezen nanejvýše jeden soubor INFO. Pokud nalezen není, je soubor špatně pojmenován, nebo
                opravdu chybí.
            </description>
            <validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="INFO_FILES"/>
                    </value>
                    <value name="size" type="INTEGER">1</value>
                </params>
            </validation>
        </rule>

        <rule name="SINGLE_PRIMARY-METS_FILE_FOUND">
            <description>Musí být nalezen nanejvýše jeden soubor PRIMARY-METS. Pokud nalezen není, je soubor špatně
                pojmenován, nebo opravdu chybí.
            </description>
            <validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="PRIMARY-METS_FILES"/>
                    </value>
                    <value name="size" type="INTEGER">1</value>
                </params>
            </validation>
        </rule>

        <rule name="SINGLE_CHECKSUM_FILE_FOUND">
            <description>Musí být nalezen nanejvýše jeden soubor CHECKSUM. Pokud nalezen není, je soubor špatně pojmenován,
                nebo opravdu chybí.
            </description>
            <validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="CHECKSUM_FILES"/>
                    </value>
                    <value name="size" type="INTEGER">1</value>
                </params>
            </validation>
        </rule>


        <!--názvy top-level souborů obsahují povolené znaky-->

        <rule name="INFO_FILENAME_VALID">
            <description>Název souboru INFO smí obsahovat jen povolené znaky.</description>
            <validation functionName="checkFilenameMatchesPattern">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <pattern name="pattern">
                        <pattern-ref name="FILENAME"/>
                    </pattern>
                </params>
            </validation>
        </rule>

        <rule name="PRIMARY-METS_FILENAME_VALID">
            <description>Název souboru PRIMARY-METS smí obsahovat jen povolené znaky.</description>
            <validation functionName="checkFilenameMatchesPattern">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                    <pattern name="pattern">
                        <pattern-ref name="FILENAME"/>
                    </pattern>
                </params>
            </validation>
        </rule>

        <rule name="CHECKSUM_FILENAME_VALID">
            <description>Název souboru CHECKSUM smí obsahovat jen povolené znaky.</description>
            <validation functionName="checkFilenameMatchesPattern">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                    <pattern name="pattern">
                        <pattern-ref name="FILENAME"/>
                    </pattern>
                </params>
            </validation>
        </rule>


        <!--top-level soubory nejsou adresáře-->

        <rule name="INFO_IS_NOT_DIR">
            <description>Soubor INFO nesmí být adresář, ale obyčejný soubor.</description>
            <validation functionName="checkFileIsNotDir">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="PRIMARY-METS_IS_NOT_DIR">
            <description>Soubor PRIMARY-METS nesmí být adresář, ale obyčejný soubor.</description>
            <validation functionName="checkFileIsNotDir">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="CHECKSUM_IS_NOT_DIR">
            <description>Soubor CHECKSUM nesmí být adresář, ale obyčejný soubor.</description>
            <validation functionName="checkFileIsNotDir">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>


        <!--žádné top-level soubory/adresáře kromě očekávaných a tolerovaných-->

        <rule name="TOLERATED_TL_FILES_ARE_NOT_DIRS">
            <description>Žádný tolerovaný soubor v kořenovém adresáři nesmí být adresář.</description>
            <validation functionName="checkNoFileIsDir">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="TOLERATED_TL_FILES"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="NO_TOLERATED_TL_FILES_FOUND">
            <description>Ideálně by v kořenovém adresáři neměl být nalezen žádný tolerovaný soubor.</description>
            <validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="TOLERATED_TL_FILES"/>
                    </value>
                    <value name="size" type="INTEGER">0</value>
                    <value name="level" type="LEVEL">WARNING</value>
                </params>
            </validation>
            <!--
                        <validation functionName="CHECK_FILE_LIST_EMPTY">
                            <params>
                                <value name="files" type="FILE_LIST">
                                    <value-ref name="TOLERATED_TL_FILES"/>
                                </value>
                            </params>
                        </validation>-->
        </rule>

        <rule name="NO_OTHER_TL_FILES_FOUND">
            <description>
                Kromě definovaných a tolerovaných souborů a adresářů nesmí být v kořenovém adresáři nalezen žádný další soubor nebo adresář.
            </description>
            <validation functionName="checkNoOtherFilesInDir">
                <params>
                    <value name="root_dir" type="FILE">
                        <value-ref name="PSP_DIR"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="TOLERATED_TL_FILES"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="ORIGINAL-DIR_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>


        <!--právě jeden každý top-level adresář-->

        <rule name="SINGLE_ORIGINAL-DIR-DIR_FILE_FOUND">
            <description>Musí být nalezen právě jeden adresář ORIGINAL. Pokud nalezen není, je
                adresář špatně pojmenován, nebo opravdu chybí.
            </description>
            <validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-DIR_FILES"/>
                    </value>
                    <value name="size" type="INTEGER">1</value>
                </params>
            </validation>
        </rule>


        <!--názvy top-level adresářů obsahují povolené znaky-->

        <rule name="ORIGINAL-DIR_FILE_VALID">
            <description>Název adresáře ORIGINAL musí obsahovat jen povolené znaky.</description>
            <validation functionName="checkFilenameMatchesPattern">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="ORIGINAL-DIR_FILE"/>
                    </value>
                    <pattern name="pattern">
                        <pattern-ref name="FILENAME"/>
                    </pattern>
                </params>
            </validation>
        </rule>


        <!--top-level adresáře jsou adresáře (ne obyčejné soubory)-->

        <rule name="ORIGINAL-DIR_FILE_IS_DIR">
            <description>Soubor ORIGINAL musí být adresář a ne obyčejný soubor.</description>
            <validation functionName="checkFileIsDir">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="ORIGINAL-DIR_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>


        <!--top-level adresáře jsou adresáře (ne obyčejné soubory)-->

        <rule name="ORIGINAL-DIR_FILE_IS_DIR">
            <description>Soubor ORIGINAL musí být adresář a ne obyčejný soubor.</description>
            <validation functionName="checkFileIsDir">
                <params>
                    <value name="file" type="FILE">
                        <value-ref name="ORIGINAL-DIR_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>


        <!--názvy souborů v adresáři original obsahují jen povolené znaky-->

        <rule name="ORIGINAL-COPY_FILENAMES_VALID">
            <description>Všechny soubory ORIGINAL-COPY musí obsahovat jen povolené znaky.</description>
            <validation functionName="checkAllFilenamesMatchPattern">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-COPY_FILES"/>
                    </value>
                    <pattern name="pattern">
                        <pattern-ref name="FILENAME"/>
                    </pattern>
                </params>
            </validation>
        </rule>


        <!--žádný ze souborů v adresáři original není adresář-->

        <rule name="ORIGINAL-COPY_FILES_ARE_NOT_DIRS">
            <description>Žádný soubor ORIGINAL-COPY nesmí být adresář.</description>
            <validation functionName="checkNoFileIsDir">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-COPY_FILES"/>
                    </value>
                </params>
            </validation>
        </rule>


        <!--žádné další soubory v adresáři original -->

        <rule name="NO_EXTRA_FILES_IN_ORIGINAL-DIR">
            <description>Kromě souborů ORIGINAL-COPY nesmí adresář ORIGINAL obsahovat žádné další soubory.</description>
            <validation functionName="checkNoOtherFilesInDir">
                <params>
                    <value name="root_dir" type="FILE">
                        <value-ref name="ORIGINAL-DIR_FILE"/>
                    </value>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-COPY_FILES"/>
                    </value>
                </params>
            </validation>
        </rule>

    </rules-section>

    <rules-section name="Soubor CHECKSUM"
                   description="Kontrola souboru CHECKSUM, odkazů na další soubory a shody kontrolních součtů.">

        <rule name="CHECKSUM_FILE_GENERATED_BY_GRAMMAR">
            <description>Soubor CHECKSUM by měl být generován předepsanou ABNF gramatikou.</description>
            <validation functionName="checkChecksumFileGeneratedByGrammar">
                <params>
                    <value name="checksum_file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="CHECKSUM_FILE_ALL_PATHS_MATCH_FILES">
            <description>Soubor CHECKSUM musí obsahovat záznamy pro každý uvedený soubor a žádný jiný.</description>
            <validation functionName="checkChecksumFileAllPathsMatchFiles">
                <params>
                    <value name="checksum_file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-COPY_FILES"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="CHECKSUM_FILE_ALL_CHECKSUMS_MATCH">
            <description>Všechny kontrolní součty v souborů odkazovaných v souboru CHECKSUM musí souhlasit.
            </description>
            <validation functionName="checkChecksumFileAllChecksumsMatch">
                <params>
                    <value name="checksum_file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

    </rules-section>

    <rules-section name="Soubor INFO"
                   description="Validace souboru INFO - odkazování na ostatní soubory, kontrolní součet pro soubor CHECKSUM, atd.">

        <rule name="INFO_XML_WELL_BUILT">
            <description>Soubor INFO musí být korektní (well-built) xml soubor.</description>
            <validation functionName="checkXmlIsWellBuilt">
                <params>
                    <value name="xml_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <rule name="INFO_XML_VALID_BY_XSD">
            <description>Soubor INFO by měl být validní podle XML Schema (info_eper2.3.xsd).</description>
            <validation functionName="checkXmlIsValidByXsd">
                <params>
                    <value name="xml_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="xsd_file" type="FILE">
                        <value-ref name="INFO_XSD_FILE"/>
                    </value>
                    <value name="level" type="LEVEL">WARNING</value>
                </params>
            </validation>
        </rule>

        <!--METS Profile requirement id infoxml6-->
        <rule name="INFO_REFERENCES_PRIMARY-METS">
            <description>Soubor INFO se musí odkazovat na soubor PRIMARY-METS přes element mainmets.</description>
            <validation functionName="checkInfoFileReferencesPrimaryMets">
                <params>
                    <value name="info_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="primary-mets_file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <!--METS Profile requirement id infoxml13-->
        <rule name="INFO_ITEMTOTAL_MATCHES_ITEMS_COUNT">
            <description>V souboru INFO musí počet elementů item souhlasit s hodnotou atributu itemtotal elementu
                itemlist.
            </description>
            <!--mozne delat i nejak takhle, zatim ale asi neni potreba takova variabilita-->
            <!--<validation functionName="checkFilelistHasExactSize">
                <params>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="INFO_ITEMS"/>
                    </value>
                    <value name="size" type="INTEGER">
                        <value-ref name="INFO_ITELMTOTAL"/>
                    </value>
                </params>
            </validation>-->
            <validation functionName="checkInfoFileItemsCountMatchesItemtotal">
                <params>
                    <value name="info_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                </params>
            </validation>

        </rule>

        <!--METS Profile requirement id infoxml13-->
        <rule name="INFO_ITEMLIST_REFERENCES_ALL_FILES">
            <description>Soubor INFO se musí odkazovat na všechny uvedené soubory přes elementy item a na žádné další.
            </description>
            <validation functionName="checkInfoFileItemlistReferencesAllFiles">
                <params>
                    <value name="info_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="level" type="LEVEL">ERROR</value>
                    <value name="file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                    <value name="file" type="FILE">
                        <value-ref name="PRIMARY-METS_FILE"/>
                    </value>
                    <value name="files" type="FILE_LIST">
                        <value-ref name="ORIGINAL-COPY_FILES"/>
                    </value>
                </params>
            </validation>
        </rule>

        <!--METS Profile requirement id infoxml14-->
        <rule name="INFO_CHECKSUM_FILE_CHECKSUM_MATCHES">
            <description>Soubor INFO se musí odkazovat na existující soubor CHECKSUM přes element checksum a kontrolní
                součet se musí shodovat.
            </description>
            <validation functionName="checkInfoFileChecksumMatches">
                <params>
                    <value name="info_file" type="FILE">
                        <value-ref name="INFO_FILE"/>
                    </value>
                    <value name="checksum_file" type="FILE">
                        <value-ref name="CHECKSUM_FILE"/>
                    </value>
                </params>
            </validation>
        </rule>

        <!--TODO:identifikatory v INFO-->

    </rules-section>

</fDMF>
